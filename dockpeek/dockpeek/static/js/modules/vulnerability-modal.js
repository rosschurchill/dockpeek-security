import { state } from './state.js';

const API_PREFIX = document.querySelector('meta[name="api-prefix"]')?.content || '';

let currentScanData = null;

export function initVulnerabilityModal() {
  // Event delegation for scan buttons and clickable vulnerability summaries
  document.addEventListener('click', handleSecurityClick);

  // Modal close handlers
  const closeBtn = document.getElementById('vuln-modal-close');
  const okBtn = document.getElementById('vuln-modal-ok');
  const rescanBtn = document.getElementById('vuln-rescan-button');
  const modal = document.getElementById('vulnerability-modal');

  if (closeBtn) closeBtn.addEventListener('click', closeVulnModal);
  if (okBtn) okBtn.addEventListener('click', closeVulnModal);
  if (rescanBtn) rescanBtn.addEventListener('click', handleRescan);

  // Close on overlay click
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeVulnModal();
    });
  }

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeVulnModal();
      closeScanProgressModal();
    }
  });
}

function handleSecurityClick(e) {
  // Handle scan button click
  const scanBtn = e.target.closest('.scan-now-btn');
  if (scanBtn) {
    e.preventDefault();
    const server = scanBtn.dataset.server;
    const container = scanBtn.dataset.container;
    const image = scanBtn.dataset.image;
    triggerScan(server, container, image, scanBtn);
    return;
  }

  // Handle clickable vulnerability summary
  const vulnSummary = e.target.closest('.vuln-clickable');
  if (vulnSummary) {
    e.preventDefault();
    const server = vulnSummary.dataset.server;
    const container = vulnSummary.dataset.container;
    const image = vulnSummary.dataset.image;
    showVulnerabilityDetails(server, container, image);
    return;
  }
}

async function triggerScan(server, container, image, buttonElement) {
  if (!image) return;

  // Show scan in progress
  buttonElement.classList.add('scanning');
  showScanProgressModal(image);

  try {
    const response = await fetch(`${API_PREFIX}/api/scan/${encodeURIComponent(image)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ server })
    });

    const result = await response.json();

    closeScanProgressModal();

    if (result.status === 'success' && result.result) {
      // Update the container data in state
      updateContainerVulnerabilities(server, container, result.result);

      // Show results modal
      showVulnerabilityModal(container, image, result.result);
    } else {
      showScanError(result.error || 'Scan failed');
    }
  } catch (error) {
    closeScanProgressModal();
    showScanError(error.message);
  } finally {
    buttonElement.classList.remove('scanning');
  }
}

async function showVulnerabilityDetails(server, container, image) {
  if (!image) return;

  showVulnModal();
  setModalLoading();

  try {
    // Try to get cached results first
    const response = await fetch(`${API_PREFIX}/api/vulnerabilities/${encodeURIComponent(image)}`);
    const result = await response.json();

    if (result.cached && result.result) {
      showVulnerabilityModal(container, image, result.result);
    } else {
      // Need to scan
      showScanProgressModal(image);
      closeVulnModal();

      const scanResponse = await fetch(`${API_PREFIX}/api/scan/${encodeURIComponent(image)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ server })
      });

      const scanResult = await scanResponse.json();
      closeScanProgressModal();

      if (scanResult.status === 'success' && scanResult.result) {
        updateContainerVulnerabilities(server, container, scanResult.result);
        showVulnerabilityModal(container, image, scanResult.result);
      } else {
        showScanError(scanResult.error || 'Scan failed');
      }
    }
  } catch (error) {
    closeVulnModal();
    showScanError(error.message);
  }
}

function showVulnerabilityModal(container, image, scanResult) {
  currentScanData = { container, image, scanResult };

  const modal = document.getElementById('vulnerability-modal');
  const title = document.getElementById('vuln-modal-title');
  const imageEl = document.getElementById('vuln-modal-image');
  const countsEl = document.getElementById('vuln-modal-counts');
  const listEl = document.getElementById('vuln-modal-list');

  if (title) title.textContent = `Vulnerabilities: ${container}`;
  if (imageEl) imageEl.textContent = image;

  // Build summary counts
  if (countsEl) {
    const summary = scanResult.summary || {};
    const badges = [];

    if (summary.critical > 0) {
      badges.push(`<span class="vuln-badge vuln-critical">${summary.critical} Critical</span>`);
    }
    if (summary.high > 0) {
      badges.push(`<span class="vuln-badge vuln-high">${summary.high} High</span>`);
    }
    if (summary.medium > 0) {
      badges.push(`<span class="vuln-badge vuln-medium">${summary.medium} Medium</span>`);
    }
    if (summary.low > 0) {
      badges.push(`<span class="vuln-badge vuln-low">${summary.low} Low</span>`);
    }

    if (badges.length === 0) {
      badges.push(`<span class="vuln-badge vuln-clean">No vulnerabilities found</span>`);
    }

    countsEl.innerHTML = badges.join(' ');
  }

  // Build vulnerability list
  if (listEl) {
    const vulnerabilities = scanResult.vulnerabilities || [];

    if (vulnerabilities.length === 0) {
      listEl.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <svg class="w-12 h-12 mx-auto mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
          </svg>
          <p class="font-medium text-green-600">No vulnerabilities detected</p>
          <p class="text-sm mt-1">This image passed the security scan</p>
        </div>
      `;
    } else {
      // Sort by severity
      const severityOrder = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3, UNKNOWN: 4 };
      vulnerabilities.sort((a, b) => {
        return (severityOrder[a.severity] || 4) - (severityOrder[b.severity] || 4);
      });

      listEl.innerHTML = vulnerabilities.map(vuln => renderVulnerabilityItem(vuln)).join('');
    }
  }

  showVulnModal();
}

function renderVulnerabilityItem(vuln) {
  const severityClass = `vuln-severity-${(vuln.severity || 'unknown').toLowerCase()}`;
  const cveUrl = vuln.vulnerability_id?.startsWith('CVE-')
    ? `https://nvd.nist.gov/vuln/detail/${vuln.vulnerability_id}`
    : null;

  // Format CVSS score with color coding
  let cvssHtml = '';
  if (vuln.cvss_score) {
    const score = parseFloat(vuln.cvss_score);
    let cvssClass = 'cvss-low';
    if (score >= 9.0) cvssClass = 'cvss-critical';
    else if (score >= 7.0) cvssClass = 'cvss-high';
    else if (score >= 4.0) cvssClass = 'cvss-medium';
    cvssHtml = `<span class="vuln-cvss-score ${cvssClass}" title="${vuln.cvss_vector || ''}">${score.toFixed(1)}</span>`;
  }

  return `
    <div class="vuln-item">
      <div class="vuln-item-header">
        <span class="vuln-id">
          ${cveUrl ? `<a href="${cveUrl}" target="_blank" rel="noopener">${vuln.vulnerability_id}</a>` : vuln.vulnerability_id}
        </span>
        <div class="vuln-badges">
          ${cvssHtml}
          <span class="vuln-severity-badge ${severityClass}">${vuln.severity || 'UNKNOWN'}</span>
        </div>
      </div>
      <div class="vuln-package">
        Package: <code>${vuln.pkg_name || 'unknown'}</code>
        ${vuln.installed_version ? ` (${vuln.installed_version})` : ''}
      </div>
      ${vuln.title ? `<div class="vuln-description">${escapeHtml(vuln.title)}</div>` : ''}
      ${vuln.fixed_version ? `<div class="vuln-fix">Fix available: <code>${vuln.fixed_version}</code></div>` : ''}
    </div>
  `;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function handleRescan() {
  if (!currentScanData) return;

  const { container, image } = currentScanData;
  closeVulnModal();

  // Find container in state to get server
  const containerData = state.allContainersData
    .flatMap(s => s.containers || [])
    .find(c => c.name === container && c.image === image);

  if (containerData) {
    showScanProgressModal(image);
    triggerRescan(containerData.server, container, image);
  }
}

async function triggerRescan(server, container, image) {
  try {
    const response = await fetch(`${API_PREFIX}/api/scan/${encodeURIComponent(image)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ server, force: true })
    });

    const result = await response.json();
    closeScanProgressModal();

    if (result.status === 'success' && result.result) {
      updateContainerVulnerabilities(server, container, result.result);
      showVulnerabilityModal(container, image, result.result);
    } else {
      showScanError(result.error || 'Rescan failed');
    }
  } catch (error) {
    closeScanProgressModal();
    showScanError(error.message);
  }
}

function updateContainerVulnerabilities(server, containerName, scanResult) {
  // Update the container data in state
  for (const serverData of state.allContainersData) {
    if (serverData.name === server && serverData.containers) {
      for (const container of serverData.containers) {
        if (container.name === containerName) {
          container.vulnerability_summary = {
            critical: scanResult.summary?.critical || 0,
            high: scanResult.summary?.high || 0,
            medium: scanResult.summary?.medium || 0,
            low: scanResult.summary?.low || 0,
            scan_status: 'scanned',
            scan_timestamp: new Date().toISOString()
          };
          break;
        }
      }
      break;
    }
  }

  // Trigger a re-render event
  document.dispatchEvent(new CustomEvent('containers-updated'));
}

function showVulnModal() {
  const modal = document.getElementById('vulnerability-modal');
  if (modal) modal.classList.remove('hidden');
}

function closeVulnModal() {
  const modal = document.getElementById('vulnerability-modal');
  if (modal) modal.classList.add('hidden');
  currentScanData = null;
}

function setModalLoading() {
  const listEl = document.getElementById('vuln-modal-list');
  if (listEl) {
    listEl.innerHTML = '<div class="text-center text-gray-500 py-8">Loading vulnerabilities...</div>';
  }
}

function showScanProgressModal(image) {
  const modal = document.getElementById('scan-progress-modal');
  const imageEl = document.getElementById('scan-progress-image');
  if (modal) modal.classList.remove('hidden');
  if (imageEl) imageEl.textContent = image;
}

function closeScanProgressModal() {
  const modal = document.getElementById('scan-progress-modal');
  if (modal) modal.classList.add('hidden');
}

function showScanError(message) {
  // Use the existing error modal pattern
  const errorModal = document.getElementById('update-error-modal');
  const errorMessage = document.getElementById('update-error-message');

  if (errorModal && errorMessage) {
    errorMessage.textContent = `Vulnerability scan failed: ${message}`;
    errorModal.classList.remove('hidden');
  } else {
    alert(`Scan error: ${message}`);
  }
}
